<script>
  /*********************************************\
                   ChesSkelet JS

        a port of ChesSkelet by Alex Garcia
          from Z80 assembly to JavaScript

                by Code Monkey King

  \*********************************************/

  /*********************************************\
 
     Color encoding:

         White = 0
         Black = 1

     Piece encoding:
     
         wP = 0x05   0 0 00  01 01
         wN = 0x11   0 0 01  00 01
         wB = 0x19   0 0 01  10 01
         wR = 0x29   0 0 10  10 01
         wQ = 0x39   0 0 11  10 01
         wK = 0x51   0 1 01  00 01

         bP = 0x07   0 0 00  01 11
         bN = 0x13   0 0 01  00 11
         bB = 0x1B   0 0 01  10 11
         bR = 0x2B   0 0 10  10 11
         bQ = 0x3B   0 0 11  10 11
         bK = 0x53   0 1 01  00 11

         Bit0: set to 1 for all pieces
         Bit1: piece color
         Bit2: identifies pawns
         Bit3: identifies slider pieces
         Bit4: contributes to piece value
         Bit5: contributes to piece value
         Bit6: identifies the King
         Bit2 - Bit6: piece value

  \*********************************************/

  // Chess piece encoding
  const eS = 0x00;
  const wP = 0x05;
  const wN = 0x11;
  const wB = 0x19;
  const wR = 0x29;
  const wQ = 0x39;
  const wK = 0x51;
  const bP = 0x07;
  const bN = 0x13;
  const bB = 0x1B;
  const bR = 0x2B;
  const bQ = 0x3B;
  const bK = 0x53;

  // Chess piece representation
  let pieces = {
    0x00: '.',
    0x07: 'p',
    0x13: 'n',
    0x1B: 'b',
    0x2B: 'r',
    0x3B: 'q',
    0x53: 'k',
    0x05: 'P',
    0x11: 'N',
    0x19: 'B',
    0x29: 'R',
    0x39: 'Q',
    0x51: 'K',
  };

 /* var board = [                                                  // Chess board representation
    bR, bN, bB, bQ, bK, bB, bN, bR,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 8 + dummy squares
    bP, bP, bP, bP, bP, bP, bP, bP,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 7 + dummy squares
    eS, eS, eS, eS, eS, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 6 + dummy squares
    eS, eS, eS, eS, eS, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 5 + dummy squares
    eS, eS, eS, eS, eS, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 4 + dummy squares
    eS, eS, eS, eS, eS, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 3 + dummy squares
    wP, wP, wP, wP, wP, wP, wP, wP,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 2 + dummy squares
    wR, wN, wB, wQ, wK, wB, wN, wR,  0, 0, 0, 0, 0, 0, 0, 0      // Rank 1 + dummy squares
  ];*/
  var board = [                                                  // Chess board representation
    eS, eS, eS, eS, eS, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 8 + dummy squares
    eS, eS, eS, eS, eS, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 7 + dummy squares
    eS, eS, eS, eS, eS, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 6 + dummy squares
    eS, eS, eS, eS, eS, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 5 + dummy squares
    eS, eS, eS, eS, wN, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 4 + dummy squares
    eS, eS, eS, eS, eS, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 3 + dummy squares
    eS, eS, eS, eS, eS, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0,     // Rank 2 + dummy squares
    eS, eS, eS, eS, eS, eS, eS, eS,  0, 0, 0, 0, 0, 0, 0, 0      // Rank 1 + dummy squares
  ];
  
  var vector_pointers = {                                        // Move vector table pointers
    0x82: 0xF0,
    0x87: 0xFA,                                                  // Pawn moves address
    0x93: 0xF4,                                                  // Knight moves address
    0x9B: 0xFB,                                                  // Bishop moves address
    0xAB: 0xF1,                                                  // Rook moves address
    0xBB: 0xF9,                                                  // Queen moves address
    0xD3: 0xF9                                                   // King Moves address
  };

  var vector_lists = [                                           // Move vector table
    0x01, 0x10, 0x00,                                            // Rook move offsets
    0x0E, 0x1F, 0x12, 0x21, 0x00,                                // Knight move offsets
    0x01, 0x10, 0x0F, 0x11, 0x00                                 // Queen/King, Pawn (+1), Bishop (+2)
  ];

  let position = "";                                             // Board position string representation
  for (let source_sq = 0; source_sq < 128; source_sq++) {                 // Loop over board source_sqs
    if ((source_sq & 0x08) == 0) {                                  // If source_sq is on board
      let piece = board[source_sq];                                 // Get source_sq content
      if (piece) {                                               // If there's a piece on a source_sq
        let vector_pointer = vector_pointers[piece | 0x82];
        vector_pointer -= 0xF1;
        let vector_offset = 1;
        let direction = 1;
        let offset_number = 0;
        while (vector_offset) {
          vector_offset = vector_lists[vector_pointer] * direction;
          if (vector_offset == 0) break;
          let target_sq = source_sq;
          while (1) {
            target_sq += vector_offset;
            if ((target_sq & 0x88)) break;

            
            board[target_sq+8] = 0x10; // debug mark attacked square


            if ((piece & 0x08) == 0) break;                      // Do not follow attack ray for leaper pieces
          }
          if (direction > 0) {
            vector_pointer++;
            offset_number++;
            if (vector_lists[vector_pointer] == 0) {
              direction = -1;
              vector_pointer--;
            }
          } else {
            vector_pointer--;
            offset_number--;
            if (offset_number == 0) break;
          }
        }
      }
      position += pieces[piece];                                 // Print source_sq content
    } else {                                                     // Otherwise source_sq is off board
      position += "\n";                                          // Print new line
      source_sq += 7;                                               // Skip offboard source_sqs
    }
  }

  // Print board
  console.log(position)

  function printAttackBoard() {
    let attacks = "";
    for (let sq = 0; sq < 128; sq++) {                 // Loop over board source_sqs
      if ((sq & 0x08) == 8) {
        attacks += board[sq] ? "x": ".";
      } else {
        attacks += "\n";
        sq += 7;
      }
    }
    console.log(attacks);
  }

  printAttackBoard();

</script>
